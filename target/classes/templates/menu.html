<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - Lilies & Latte</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #fffaf5; color: #1f1f1f; }
        .nav { background-color: #ffffff; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .nav-left a { margin-right: 20px; text-decoration: none; color: #5d4037; font-weight: bold; transition: color 0.3s; }
        .nav-left a:hover { color: #51372c; }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .cart-badge { position: relative; cursor: pointer; }
        .cart-badge svg { width: 24px; height: 24px; fill: #5d4037; }
        .cart-count { position: absolute; top: -8px; right: -8px; background-color: #b71c1c; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75em; font-weight: bold; }
        .user-info { font-weight: 500; }
        .btn-logout { padding: 8px 16px; background-color: #b71c1c; color: #fff; text-decoration: none; border-radius: 4px; border: none; cursor: pointer; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        h1 { text-align: center; color: #6B4E3A; margin-bottom: 24px; font-size: 2.25em; }
        .filter-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .filter-btn { padding: 10px 20px; border: 2px solid #6B4E3A; background-color: white; color: #1f1f1f; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .filter-btn:hover, .filter-btn.active { background-color: #6B4E3A; color: white; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
        .menu-item { background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); overflow: hidden; text-align: center; transition: transform 0.2s; }
        .menu-item:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .menu-item img { width: 100%; height: 200px; object-fit: cover; }
        .menu-item-content { padding: 20px; }
        .menu-item-content h3 { margin: 0 0 10px; color: #5d4037; font-size: 1.3em; }
        .menu-item-content p { font-size: 0.9em; color: #1f1f1f; margin-bottom: 10px; }
        .calories { font-size: 0.85em; color: #51372c; font-style: italic; }
        .menu-item-footer { display: flex; justify-content: space-between; align-items: center; padding: 0 20px 20px; }
        .price { font-weight: bold; font-size: 1.3em; color: #1f1f1f; }
        .add-to-cart-btn { background-color: #6B4E3A; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .add-to-cart-btn:hover { background-color: #51372c; }
        .add-to-cart-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .unavailable { opacity: 0.5; }
        .unavailable-badge { background-color: #b71c1c; color: white; padding: 5px 10px; border-radius: 3px; font-size: 0.85em; font-weight: bold; }
        .notification { position: fixed; top: 20px; right: 20px; background-color: #2E7D32; color: white; padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div th:replace="~{fragments/nav :: nav}"></div>

    <div class="container">
        <h1>Our Menu</h1>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterMenu(event,'all')" aria-pressed="true">All</button>
            <button class="filter-btn" onclick="filterMenu(event,'Coffee')" aria-pressed="false">Coffee</button>
            <button class="filter-btn" onclick="filterMenu(event,'Tea')" aria-pressed="false">Tea</button>
            <button class="filter-btn" onclick="filterMenu(event,'Pastries')" aria-pressed="false">Pastries</button>
            <button class="filter-btn" onclick="filterMenu(event,'Sandwiches')" aria-pressed="false">Sandwiches</button>
        </div>

        <div class="menu-grid" id="menu-grid">
            <div th:each="item : ${menuItems}" th:class="'menu-item' + (${item.available} ? '' : ' unavailable')" th:attr="data-category=${item.category}">
                <img th:src="${item.imageUrl}" th:alt="${item.name}" src="https://via.placeholder.com/300x200.png?text=Menu+Item">
                <div class="menu-item-content">
                    <h3 th:text="${item.name}">Menu Item</h3>
                    <p th:text="${item.description}">Description</p>
                    <p class="calories" th:text="'Calories: ' + ${item.calories}">Calories: 0</p>
                </div>
                <div class="menu-item-footer">
                    <span class="price" th:text="'SAR ' + ${#numbers.formatDecimal(item.price, 1, 2)}">SAR 0.00</span>
                    <button th:if="${item.available}" 
                            class="add-to-cart-btn" 
                            th:attr="data-id=${item.id}, data-name=${item.name}, data-price=${item.price}"
                            onclick="addToCart(this)">
                        Add to Cart
                    </button>
                    <span th:unless="${item.available}" class="unavailable-badge">Unavailable</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFilter = 'all';

        function filterMenu(ev, category) {
            currentFilter = category;
            const menuItems = document.querySelectorAll('.menu-item');
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(btn => btn.classList.remove('active'));
            ev.target.classList.add('active');
            
            menuItems.forEach(item => {
                const itemCategory = item.getAttribute('data-category');
                if (category === 'all' || itemCategory === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        async function addToCart(button) {
            const itemId = button.getAttribute('data-id');
            const itemName = button.getAttribute('data-name');
            
            try {
                button.disabled = true;
                button.textContent = 'Adding...';
                
                const response = await fetch('/api/cart/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        menuItemId: itemId,
                        quantity: 1
                    })
                });
                
                if (response.ok) {
                    showNotification(`${itemName} added to cart!`);
                    updateCartCount();
                } else {
                    showNotification('Please login to add items to cart', 'error');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                showNotification('Error adding item to cart', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Add to Cart';
            }
        }

        async function updateCartCount() {
            try {
                const response = await fetch('/api/cart');
                if (response.ok) {
                    const cart = await response.json();
                    const count = cart.cartItems ? cart.cartItems.reduce((sum, item) => sum + item.quantity, 0) : 0;
                    document.getElementById('cart-count').textContent = count;
                }
            } catch (error) {
                console.error('Error updating cart count:', error);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = type === 'error' ? 'notification error' : 'notification success';
            notification.setAttribute('role', 'status');
            notification.setAttribute('aria-live', 'polite');
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Update cart count logic is handled by fragment
    </script>
</body>
</html>